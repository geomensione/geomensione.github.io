<!DOCTYPE html>
<html>
<head>
<title>Diegoli's site</title>

</head>
<body>
    <canvas>
      What, no canvas support? D:
    </canvas>
	
 <script>
	"use strict";
	window.a = document.getElementsByTagName('canvas')[0];
	window.b = document.getElementsByTagName('body')[0];
	window.c = window.a.getContext('2d');
	window.d = document;
	
	/*
	LRDraw tool start
	*/
	//Init
	 /*
	 coordinate click: 2, 10

	(index):228 coordinate click: 6, 9

	(index):228 coordinate click: 10, 10

	(index):228 coordinate click: 14, 8

	(index):228 coordinate click: 17, 17

	(index):228 coordinate click: 18, 10

	(index):228 coordinate click: 22, 9

	(index):228 coordinate click: 26, 10

	(index):228 coordinate click: 31, 8

	(index):228 coordinate click: 36, 9
	 */
	var g = {};
	a.width = window.innerWidth;
	a.height = window.innerHeight;
	 
	g.w = window.innerWidth;
	g.h = window.innerHeight;
	g.r = 24;//48;-> 4 min pixel
	g.s = 8;
	g.o = 0;
	g.fr = 100;
	g.color = '7';
	g.tmp = [[["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","B","B"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","7","7","7","7","7","B"],["B","0","0","0","0","0","0","0","0","B","0","7","7","7","7","7","7","1","1","7","7","7","7","B"],["0","0","0","0","0","0","0","0","B","0","0","7","7","7","7","7","7","1","1","1","7","7","7","B"],["0","0","0","0","0","0","B","0","0","0","0","7","7","7","7","7","7","1","1","1","1","7","7","B"],["0","0","0","0","B","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","7","7","B"],["0","0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","7","7","B"],["0","0","0","B","B","0","0","0","0","B","7","7","7","7","7","1","1","1","1","1","1","7","7","B"],["0","0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","7","7","B"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","7","7","B"],["0","0","0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","7","7","B"],["0","0","0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","7","B"],["0","0","0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","7","B"],["0","0","0","0","0","0","0","0","0","0","0","B","0","1","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","B","B","0","0","0","0","0","B","0","1","1","1","1","1","7","7","7","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","7","7","7","7","7","1","1","7","7","7","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","7","7","7","7","7","1","1","7","7","7","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","7","B"],["0","0","B","0","0","B","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","7","B"],["0","0","0","B","0","B","0","0","0","0","7","7","7","7","7","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","0","0","7","7","7","7","7","7","1","1","1","1","1","7","B"],["0","B","0","0","0","B","0","0","0","0","0","7","7","7","7","7","7","1","1","1","1","1","7","B"],["0","B","0","0","0","B","0","0","0","0","0","7","7","7","7","7","7","1","1","1","1","1","7","B"],["0","B","0","0","0","B","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","7","B"],["0","0","0","B","0","B","0","0","0","0","0","0","0","0","1","1","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","7","7","7","7","7","7","7","1","1","1","1","1","1","7","B"],["0","0","0","0","0","B","0","0","0","7","7","7","7","7","7","7","1","1","1","1","1","7","7","B"],["0","0","0","0","0","B","0","0","0","7","7","7","7","7","7","7","1","1","1","1","1","7","7","B"],["0","0","0","0","0","B","B","B","0","B","0","0","0","0","0","1","1","1","1","1","1","7","7","B"],["0","0","0","0","0","B","B","B","0","B","0","0","0","0","0","1","1","1","1","1","1","7","7","B"],["0","0","B","0","0","B","B","B","B","B","7","7","7","7","7","7","7","1","1","1","7","7","7","B"],["0","0","B","B","0","B","B","B","B","B","7","7","7","7","7","7","7","1","1","1","7","7","7","B"],["B","B","B","B","B","B","B","B","B","B","7","7","7","7","7","7","7","1","1","1","7","7","7","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","1","1","1","1","7","7","7","7","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"],["B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B","B"]],"0"];
	let frames = [
		    	[["T","4","T"],["T","4","T"],["4","4","4"],["4","1","4"],["4","4","4"]],
		    	[["T","T","4"],["T","T","4"],["4","4","4"],["4","1","4"],["4","4","4"]],
		    	[["4","T","T"],["4","T","T"],["4","4","4"],["4","1","4"],["4","4","4"]]
	    	];
	let flames = function(x,y){
	    	let my_x = x;
		let my_y = y-frames[0].length;
		let clicked = 5;
		
	    	function setPos(x,y){
	    		my_x = x;
			my_y = y-frames[0].length;
	    	};
		function draw(f){
			return new Promise(function(resolve, reject){ 
				console.log(my_x+' '+my_y);

				if(clicked >= 5)
				{

					for(let px = 0;px<3;px++)
					{
						for(let py = 0;py<5;py++)
						{
							g.textimage[px+my_x][py+my_y] = frames[f][py][px];
						}

					}
					return resolve();

				}
				else
				{
					clicked++;
					return resolve();
				}

			});
			
			
		}
		function click(x,y){
			if((my_x <= x && x <=my_x+3) && (my_y <= y && y <=my_y+5))
			{
				clicked = 0;
				alert('clicked');
			}
		}
		return{
			setPos: setPos,
			draw: draw,
			click: click
		}
	}
	 g.textimage = g.tmp[0];
	g.background = g.tmp[1];
	g.level = 1;
	g.insertText = false;
	
	let touch = (e) =>
	 {
		let x = e.originalEvent.touches[0].pageX;
		let y = e.originalEvent.touches[0].pageY;
		down(x,y); 	
	 }
	
	 a.ontouchstart = (e) =>
	 {
		touch(e);
	 }
  
	 let mouse = (e) =>
	 {
		let x = e.clientX;
		let y = e.clientY;
		down(x,y);
	 }
  
	 a.onmousedown = (e) =>
	 {
		g.draw = true;
		  mouse(e);
	 }
	 a.ontouchmove = (e) =>
	 {
		touch(e);
	 }
	 a.onmousemove = (e) =>
	 {
		if(g.draw)
		  mouse(e);
	 }
	 a.onmouseup = (e) =>
	 {
		g.draw = false;
	 }
	 g.set_foreground_background = (color) =>
	 {
		 if(g.level === 1)
		 {
			g.color = color;
		 }else
		 {
			g.background = color;
			dr();
		 }
	 }
	 
	 d.onkeydown = (e) =>
	 {
		if(g.insertText)
		{
			if(e.key === 'Escape')
			{
				g.insertText = false;
			}
			else
			{
				g.text += e.key;
			}
			
		}
		else
		{
			switch(e.key)
			{
				case 'k':
					g.set_foreground_background('0');
					break;
				case 'r':
					g.set_foreground_background('1');
					break;
				case 'g':
					g.set_foreground_background('2');
					break;
				case 'b':
					g.set_foreground_background('3');
					break;
				case 'y':
					g.set_foreground_background('4');
					break;
				case 'p':
					g.set_foreground_background('5');
					break;
				case 'c':
					g.set_foreground_background('6');
					break;
				case 'w':
					g.set_foreground_background('7');
					break;
				case 'a':
					//http://stackoverflow.com/questions/10472927/add-content-to-a-new-open-window
					let data = []; 
					data.push(g.textimage);
					data.push(g.background);
					var OpenWindow = window.open('child.html','_blank','');
					OpenWindow.document.writeln(JSON.stringify(data));
					break;
				case 'c':
					gr();
					dr();
					break;
				case 'd':
					g.level = 0;
					break;
				case 'e':
					g.color = g.background;
					break;
				case 'f':
					g.level = 1;
					break;
				case 'l':
					localStorage.textimage = prompt('Insert image to load');
					if(localStorage.textimage)
					{
						let data = JSON.parse(decodeURIComponent(localStorage.textimage));
						g.textimage = data[0];
						g.background = data[1];
					}
					dr();
					break;
				case 'R':
					g.textimage = JSON.parse(localStorage.textimage);
					dr();
					break;
				case 's':
					localStorage.textimage = JSON.stringify(g.textimage);
					break;
				case 't':
					
					let text = prompt('You can insert '+(g.rx-g.cx)+' characters');
					if(text)
					{
						c.font = 'italic '+g.r+'pt Calibri';
						c.fillStyle = 'blue';
						
						drawText(text);
					}
					break;
			} 
		}
		
	 }
	 function drawText(str){
		 let sl = str.length;
		 for(let i = 0;i<sl;i++)
		 {
		 	c.fillText(str[i], g.cx*g.o,g.cy*g.o);
			g.textimage[g.cx][g.cy] = '*'+str[i];
			g.cx++; 
		 }
	 
	 }
	 
	 function down(x,y){
		 let cx = Math.floor(x/g.o);
		 let cy = Math.floor(y/g.o);
		 for(let f = 0, flame_coordinates_length = flame_coordinates.length;f<flame_coordinates_length;f++)
		 {
			 flames_objs[f].click(cx,cy);
		 }
		 /*
		 if(g.level === 1)
		 {
			g.cx = Math.floor(x/g.o);
			g.cy = Math.floor(y/g.o);
			console.log('coordinate click: '+g.cx+", "+g.cy+"\n");
			g.textimage[g.cx][g.cy] = g.color;
			c.fillStyle = "#"+g.fromCharToColorHex(g.color);
			c.fillRect(g.cx*g.o,g.cy*g.o,g.o,g.o); 
		 }
		 */
			
	 }; 
		 
	//create grid 
	function gr(){
		var w = g.w;
		var h = g.h;
		var ox, oy = 0;
		if(h<w){
			ox = Math.round(h/g.r);
			g.ry = Math.round(h/ox);
			g.rx = Math.round(w/ox);
		}else{
			ox = Math.round(w/g.r);
			g.rx = Math.round(w/ox);
			g.ry = Math.round(h/ox);
		}
		g.o = ox;
		var rx = g.rx;
		var ry = g.ry;
		/*
		for(var i = 0;i<rx;i++){
			g.textimage[i] = [];
			for(var d = 0;d<ry;d++){
				//qui setta il fb
				g.textimage[i][d] = 'B';
			}
		}
		
		var x = Math.floor(Math.random() * (g.rx-g.s));
		var y = Math.floor(Math.random() * (g.ry-g.s));
		for(var xo = 0;xo<g.s;xo++)
		{
			for(var yo = 0;yo<g.s;yo++)
			{
				if(g.sh[yo][xo] === 'W')
					g.fb[x+xo][y+yo] = ['FF','FF','FF'];
			}
		}
		*/
		
	}
	
	g.fromCharToColorHex = (c) =>
	{
		switch(c)
		{
			case 'T':
				return;
			case '0':
				return '000000';
			case '1':
				return 'FF0000';
			case '2':
				return '00FF00';
			case '3':
				return '0000FF';
			case '4':
				return 'FFFF00';
			case '5':
				return 'FF00FF';
			case '6':
				return '00FFFF';
			case '7':
				return 'FFFFFF';
			case 'B':
				return g.fromCharToColorHex(g.background);
		}
	}
	 
	function dr(){
		
		var rx = g.rx;
		var ry = g.ry;
		var o = g.o;
		var cx = 0, cy = 0;
		for(var i = 0;i<rx-1;i++){
			for(var d = 0;d<ry-1;d++){
				if(g.textimage[i] && g.textimage[i][d] && g.textimage[i][d].startsWith('*'))
				{
					c.font = 'italic '+g.o+'pt Calibri';
					//to avoid white background when load image
					c.fillStyle = "#"+g.fromCharToColorHex(g.background);
					c.fillRect(cx,cy,o,o); 
					c.fillStyle = "#"+g.fromCharToColorHex(g.color);
					c.fillText(g.textimage[i][d][1], cx,cy);
					
				}
				else
				{
					c.fillStyle = "#"+g.fromCharToColorHex(g.textimage[i][d]);
					c.fillRect(cx,cy,o,o);
				
				}
				cy += o;
			}
			cx += o;
			cy = 0;
		}
		
		
	}
	/*
	function l(){
		g.l = setInterval(function() {
			gr();
			dr();
		}, g.fr);
	}
	 
	l();
	*/
	 gr();
	 let flames_objs = [];
	 let flame_coordinates = [[ 2, 10],
			[ 6, 9],
			[ 10, 10],
			[ 14, 8],
			[ 17, 17],
			[ 18, 10],
			[ 22, 9],
			[ 26, 10],
			[ 31, 8],
			[ 36, 9]];
	 
	 g.framerate = 500;
	
	 for(let f = 0, flame_coordinates_length = flame_coordinates.length;f<flame_coordinates_length;f++)
	 {
		flames_objs.push(new flames(flame_coordinates[f][0],flame_coordinates[f][1]));
	}
	 function drawAll(frame) {
		 let promises = [];
		for(let f = 0, flame_coordinates_length = flame_coordinates.length;f<flame_coordinates_length;f++)
		 {
			 promises.push(flames_objs[f].draw((frame+1)%3));
		}
		 //dr();
		 Promise.all(promises).then(
		 	function(succ){
				dr();
				drawAll(frame+1);
			}
		 );
		 
	};
	
	 drawAll(0);
 </script>
</body></html>
