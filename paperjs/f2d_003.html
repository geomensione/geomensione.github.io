<html>
<head>
	<style>
		#myCanvas{
			width:100%;
			height: 100%;
		}
	</style>
  <script type="text/javascript" src="js/paper-full.min.js"></script>
  <script type="text/javascript" src="js/tangents.js"></script>
<script type="text/paperscript" canvas="myCanvas">
	var skeleton = 1;
	var bone = 0;
	var values = {
		paths: 50,
		minPoints: 5,
		maxPoints: 15,
		minRadius: 30,
		maxRadius: 90
	};

	var hitOptions = {
		segments: true,
		stroke: true,
		fill: true,
		tolerance: 5
	};

	//createPaths();

	function createPaths() {
		var radiusDelta = values.maxRadius - values.minRadius;
		var pointsDelta = values.maxPoints - values.minPoints;
		for (var i = 0; i < values.paths; i++) {
			var radius = values.minRadius + Math.random() * radiusDelta;
			var points = values.minPoints + Math.floor(Math.random() * pointsDelta);
			var path = createBlob(view.size * Point.random(), radius, points);
			var lightness = (Math.random() - 0.5) * 0.4 + 0.4;
			var hue = Math.random() * 360;
			path.fillColor = { hue: hue, saturation: 1, lightness: lightness };
			path.strokeColor = 'black';
		};
	}

	function createBlob(center, maxRadius, points) {
		var path = new Path();
		path.closed = true;
		for (var i = 0; i < points; i++) {
			var delta = new Point({
				length: (maxRadius * 0.5) + (Math.random() * maxRadius * 0.5),
				angle: (360 / points) * i
			});
			path.add(center + delta);
		}
		path.smooth();
		return path;
	}

	var segment, path;
	var movePath = false;
	var center;
	var myCircle;
	function onMouseDown(event) {
		segment = path = null;
		var hitResult = project.hitTest(event.point, hitOptions);
		if (!hitResult)
		{
			if(event.modifiers.control === true)
			{
				bone++;
				myCircle = new Path.Circle({
					center: event.point,
					radius: 1,
					name: skeleton+'_'+bone+'_'+'f2d'
				});
				
				point1 = event.point;
				var lightness = (Math.random() - 0.5) * 0.4 + 0.4;
				var hue = Math.random() * 360;
				myCircle.fillColor = { hue: hue, saturation: 1, lightness: lightness };
				myCircle.strokeColor = 'black';
				center = new Point(myCircle.segments[1].point.x, myCircle.segments[0].point.y);
			}else
			{
				return;
			}
		}
			
		if (event.modifiers.shift) {
			if (hitResult.type == 'segment') {
				hitResult.segment.remove();
			};
			return;
		}

		if (hitResult) {
			path = hitResult.item;
			if (hitResult.type == 'segment') {
				segment = hitResult.segment;
			} else if (hitResult.type == 'stroke') {
				var location = hitResult.location;
				segment = path.insert(location.index + 1, event.point);
				path.smooth();
			}
		}
		movePath = hitResult.type == 'fill';
		if (movePath)
			project.activeLayer.addChild(hitResult.item);
	}

	function onMouseMove(event) {
		project.activeLayer.selected = false;
		if (event.item)
			event.item.selected = true;
	}

	function onMouseDrag(event) {
		if (segment) {
			segment.point += event.delta;
			path.smooth();
		} else if (path) {
			path.position += event.delta;
		}else if(event.modifiers.control === true){
			var radius = (myCircle.segments[2].point.x - myCircle.segments[0].point.x) / 2; 
			let my_x = event.point.x - center.x;
			let my_y = event.point.y - center.y;
			var new_radius = new Point(my_x, my_y); 
			myCircle.scale(new_radius.length/radius);
		}
	}
	
	function onMouseUp(event){
		textItem.content = 'number of items '+((paper.project.activeLayer.children.length)-1);
		var childrens_array = project.activeLayer.children;
		var children_array_length = childrens_array.length;

		if(children_array_length > 2)
		{
			let now = skeleton+'_'+bone+'_'+'f2d';
			let prev = skeleton+'_'+(bone-1)+'_'+'f2d';
			var center1 = childrens_array[prev].position;
			var radius1 = (childrens_array[prev].segments[2].point.x - childrens_array[prev].segments[0].point.x)/2;
			var center2 = childrens_array[now].position;
			var radius2= (childrens_array[now].segments[2].point.x - childrens_array[now].segments[0].point.x)/2;
			var points = getTangents(center1.x, center1.y, radius1, center2.x, center2.y, radius2);
			var points_length = points.length;
			let tangentName = skeleton+'_'+bone+'-'+(bone-1)+'_'+'tangents';
			var lightness = (Math.random() - 0.5) * 0.4 + 0.4;
			var hue = Math.random() * 360;
			var myPathLine = new paper.Path({
				name: tangentName,
				fillColor: { hue: hue, saturation: 1, lightness: lightness }
			});
			myPathLine.strokeColor = 'black';
			for(var p = 0;p<points_length;p++)
			{
				myPathLine.add(new paper.Point(points[p].x, points[p].y));
			}
			myPathLine.closed = true;

			if(!union.name)
				union = childrens_array[prev].clone();
			let union_with_tangents = union.unite(childrens_array[tangentName]);
			union = union_with_tangents.unite(childrens_array[now]);

		}
	}
</script>
</head>
<body>
<canvas id="myCanvas" resize></canvas>
</body>
</html>
