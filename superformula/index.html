<html>
<head></head>
<body>
  <input type='text' id="uno" value="1" onchange="getFrame()"></input>
  <input type='text' id="due" value="2" onchange="getFrame()"></input>
  <input type='text' id="tre" value="3" onchange="getFrame()"></input>
  <input type='text' id="quattro" value="4" onchange="getFrame()"></input>
  <input type='text' id="scalea" value="150" onchange="getFrame()"></input>
  <input type='text' id="scaleb" value="150" onchange="getFrame()"></input>
  <input type='button' id="addShape" value="add shape" onclick="renderFormula()"></input>

<canvas id=c>
</canvas>
  
<script>


  // @see: https://en.wikipedia.org/wiki/Superformula
  //
const canvas = c,
      context = canvas.getContext("2d");

c.addEventListener('mousemove',mousemovefn);
c.addEventListener('mousedown',mousedownfn);
c.addEventListener('mouseup',mouseupfn);

var shapes = [];
var mousedown = false;
  
function mousemovefn(e){
  var x = e.clientX;
  var y = e.clientY;
  var shapes_length = shapes.length;
  for(let s = 0; s < shapes_length;s++)
    if(mousedown)
      shapes[s].move(x,y);
    else
      shapes[s].hit(x,y);
  
}
  
function mousedownfn(e){
  mousedown = true;
}
 
function mouseupfn(e){
  mousedown = false;
}
  
function renderFormula(e) {
  const uno = document.getElementById('uno').value;
  const due = document.getElementById('due').value;
  const tre = document.getElementById('tre').value;
  const quattro = document.getElementById('quattro').value;
  var s = new returnShape(uno, due, tre, quattro, 1);
  //s.draw();
  shapes.push(s);
}

function render(now) {
  resize();
  context.clearRect(0,0,canvas.width,canvas.height);
  context.save();
  context.restore();
  var shapes_length = shapes.length;
  for(let s = 0; s < shapes_length;s++)
    shapes[s].draw();
}

function frame() {
  render(uno);
}

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function getFrame(){
  window.requestAnimationFrame(frame);
  window.addEventListener("resize", resize);
  window.dispatchEvent(new Event("resize"));
}

function returnShape(now, t1, t2, t3, i) {
  var points = [];
  var maxX = 0, minX = 0, maxY = 0, minY = 0;
  var colorStroke = "#000";
  var lineWidth = 1;
  var selected = false;
  
  function superformula(phi,a,b,m,n1,n2,n3) { 
    return Math.pow( Math.pow( Math.abs( Math.cos(m * phi / 4) / a ), n2 ) + Math.pow( Math.abs( Math.sin(m * phi / 4) / b ), n3 ), -1 / n1 );
  }
  
  function draw(mx,my){
    if(!mx)
      mx = 0;
    if(!my)
      my = 0;
    var points_length = points.length;
    
    context.beginPath();
    for (let index = 0; index < points_length; index++) {
      var point = points[index];
      if (index === 0) {
        context.moveTo(point._x+mx,point._y+my);
      } else {
        context.lineTo(point._x+mx,point._y+my);
      }
    }
    context.closePath();
    context.lineWidth = lineWidth;
    context.strokeStyle = colorStroke;
    context.stroke();
  }
  
  function setPoint(x,y){
    points.push({_x:x, _y:y});
    if(x>maxX)
      maxX = x;
    if(x<minX)
      minX = x;
    if(y>maxY)
      maxY = y;
    if(y<minY)
      minY = y;
  }
  
  function move(x,y){
    this.draw(x,y);
  }
  
  function hit(x,y){
    //da rivedere, ogni volta ridisegna tutte le figure ad ogni mouse move
    var oldSelected = selected;
    if(x<maxX && x>minX && y<maxY && y > minY){
      colorStroke = '#F00';
      selected = true;
    }else{
      colorStroke = '#000';
      selected = false;
    }
    if(oldSelected !== selected)
      draw();
  }
  
  const s1 = now / t1;
  const s2 = now / t2;
  const s3 = now / t3;
  
  const a = Math.abs(Math.sin(s1));
  const b = Math.abs(Math.sin(s1));
  
  const m = Math.abs(Math.sin(s2) * 50);
  const n1 = Math.abs(Math.sin(s3) * 50);
  const n2 = Math.abs(Math.sin(s2) * 50);
  const n3 = Math.abs(Math.sin(s1) * 50);
  
  //context.beginPath();
  for (let index = 0; index < 360; index++) {
    const radius = superformula(index / 360 * Math.PI * 2,a,b,m,n1,n2,n3);
    const scalea = document.getElementById('scalea').value;
    const scaleb = document.getElementById('scaleb').value;
    const x = Math.cos(index / 360 * Math.PI * 2) * radius * scalea;
    const y = Math.sin(index / 360 * Math.PI * 2) * radius * scaleb;
    setPoint(x,y);
    
  }
  return{
    draw: draw,
    hit: hit,
    move: move
  }
}

getFrame();
</script>
</body>
</html>
